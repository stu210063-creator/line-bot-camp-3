import streamlit as st
import pandas as pd

# è¨­å®šç¶²é æ¨™é¡Œèˆ‡ç‰ˆé¢
st.set_page_config(
    page_title="2026 é«˜ä¸­ç”Ÿç†ç§‘å¯’å‡ç‡ŸéšŠæœå°‹å¼•æ“",
    page_icon="â„ï¸",
    layout="centered"
)

# --- 1. è®€å– Google Sheet è³‡æ–™ ---
@st.cache_data(ttl=600) # ttl=600 ä»£è¡¨æ¯ 10 åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡
def load_data():
    # é€™æ˜¯ä½ å‰›å‰›çµ¦æˆ‘çš„ç¶²å€ï¼Œæˆ‘å·²ç¶“è½‰æˆ CSV ä¸‹è¼‰æ¨¡å¼äº†
    sheet_url = "https://docs.google.com/spreadsheets/d/1hy7IEADYmXKVomJb3KmF0gFI6pB_Cd0SFd4sbSfHbZQ/export?format=csv"
    
    try:
        # pandas ç›´æ¥è®€å–ç·šä¸Šçš„ CSV é€£çµ
        df = pd.read_csv(sheet_url)
        # æŠŠç©ºå€¼è£œä¸Šç©ºç™½å­—ä¸²ï¼Œé¿å…ç¨‹å¼å‡ºéŒ¯
        df = df.fillna("")
        return df
    except Exception as e:
        st.error(f"ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ Google Sheet æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œå…¬é–‹/æª¢è¦–ã€ã€‚\néŒ¯èª¤è¨Šæ¯: {e}")
        return pd.DataFrame()

# --- 2. æ‡‰ç”¨ç¨‹å¼ä¸»ä»‹é¢ ---
def main():
    st.title("â„ï¸ 2026 é«˜ä¸­ç”Ÿç†ç§‘å¯’å‡ç‡ŸéšŠ")
    st.caption("è³‡æ–™ä¾†æºï¼šGoogle Sheet ç·šä¸Šè³‡æ–™åº« (å³æ™‚æ›´æ–°)")

    # è¼‰å…¥è³‡æ–™
    df = load_data()

    # å¦‚æœè³‡æ–™æ˜¯ç©ºçš„ï¼Œå°±åœæ­¢åŸ·è¡Œ
    if df.empty:
        st.warning("âš ï¸ ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œæˆ–é€£çµæ¬Šé™æ²’é–‹ã€‚è«‹æª¢æŸ¥ Google Sheet å…±ç”¨è¨­å®šã€‚")
        st.stop()

    # --- 3. å´é‚Šæ¬„ï¼šç¯©é¸æ¢ä»¶ ---
    with st.sidebar:
        st.header("ğŸ¯ ç¯©é¸æ¢ä»¶")
        
        # å»ºç«‹ç¯©é¸å–®
        # ä½¿ç”¨ set() ä¾†éæ¿¾é‡è¤‡çš„é¸é …ï¼Œä¸¦è½‰å› list æ’åº
        # ç¢ºä¿è³‡æ–™è½‰ç‚ºå­—ä¸² (astype(str)) ä»¥é¿å…è®€åˆ°ç©ºå€¼å‡ºéŒ¯
        all_locations = ["å…¨éƒ¨"] + sorted(list(set(df["åœ°å€"].astype(str))))
        selected_location = st.selectbox("ğŸ“ èˆ‰è¾¦åœ°å€", all_locations)
        
        all_categories = ["å…¨éƒ¨"] + sorted(list(set(df["é ˜åŸŸ"].astype(str))))
        selected_category = st.selectbox("ğŸ“š å­¸ç¾¤é ˜åŸŸ", all_categories)
        
        search_query = st.text_input("ğŸ” é—œéµå­—æœå°‹", placeholder="ä¾‹å¦‚ï¼šæˆå¤§ã€é†«å­¸")
        
        # é‡æ–°æ•´ç†æŒ‰éˆ• (æ–¹ä¾¿ä½ æ¸¬è©¦è³‡æ–™æ›´æ–°)
        if st.button("ğŸ”„ æ›´æ–°è³‡æ–™"):
            st.cache_data.clear() # æ¸…é™¤å¿«å–
            st.rerun()            # é‡æ–°åŸ·è¡Œ

    # --- 4. è³‡æ–™éæ¿¾é‚è¼¯ ---
    filtered_df = df.copy()

    if selected_location != "å…¨éƒ¨":
        filtered_df = filtered_df[filtered_df["åœ°å€"] == selected_location]
    
    if selected_category != "å…¨éƒ¨":
        filtered_df = filtered_df[filtered_df["é ˜åŸŸ"] == selected_category]

    if search_query:
        # æ¨¡ç³Šæœå°‹ï¼šåç¨±ã€ä¸»è¾¦å–®ä½ã€é—œéµå­— åªè¦å…¶ä¸­ä¸€å€‹æœ‰å°æ‡‰åˆ°å°±ç®—
        mask = (
            filtered_df["ç‡ŸéšŠåç¨±"].astype(str).str.contains(search_query, case=False) |
            filtered_df["ä¸»è¾¦å–®ä½"].astype(str).str.contains(search_query, case=False) |
            filtered_df["é—œéµå­—"].astype(str).str.contains(search_query, case=False)
        )
        filtered_df = filtered_df[mask]

    # --- 5. é¡¯ç¤ºçµæœ ---
    st.subheader(f"æœå°‹çµæœï¼šå…± {len(filtered_df)} å€‹ç‡ŸéšŠ")
    
    if len(filtered_df) == 0:
        st.info("æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç‡ŸéšŠã€‚")
    else:
        for index, row in filtered_df.iterrows():
            with st.container():
                c1, c2 = st.columns([0.8, 0.2])
                
                with c1:
                    st.markdown(f"### {row['ç‡ŸéšŠåç¨±']}")
                    st.markdown(f"**å–®ä½**ï¼š{row['ä¸»è¾¦å–®ä½']} | **åœ°é»**ï¼š{row['åœ°é»']}")
                    st.markdown(f"**æ™‚é–“**ï¼š{row['é ä¼°æœˆä»½']} | **é ˜åŸŸ**ï¼š`{row['é ˜åŸŸ']}`")
                
                with c2:
                    st.write("") # æ’ç‰ˆç©ºæ ¼
                    # è®€å– Excel è£¡é¢çš„é€£çµæ¬„ä½ï¼Œå¦‚æœç©ºçš„å°±è‡ªå‹•ç”¢ç”Ÿ Google æœå°‹é€£çµ
                    link = row['é€£çµ'] if str(row['é€£çµ']).startswith("http") else f"https://www.google.com/search?q={row['ç‡ŸéšŠåç¨±']}"
                    st.link_button("ğŸ‘‰ æŸ¥çœ‹", link, use_container_width=True)
                
                st.divider()

if __name__ == "__main__":
    main()
